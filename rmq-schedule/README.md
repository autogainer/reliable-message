# 核心定时任务
## 检查任务--CheckTask
```java
/**
 * <p>Description:
 * 消息确认子系统定时任务
 * </p>
 *
 * @author Chen Nan
 * @date 2019/3/18.
 */
//说明：处理所有长时间未确认的消息，向上游业务系统确认是否发送该消息
```
1.查库消费队列列表，每个消费队列进行以下一次循环  
2.根据queue配置筛选数据：  
未确认超时时间、状态为待确认(常量)、队列名、排序字段消息创建时间(常量)  
3.根据线程池配置多线程循环处理消息：  
向queue中配置的地址发送消息（httpPost）！！上游系统实现此查询服务！！  
解析应答：  
系统成功-->判断业务状态-->需要发送-->调用rmqService.confirmAndSendMessage(message.getId());  
　　　　　　　　　　　　-->不需要发送-->直接删除messageService.deleteByPrimaryKey(message.getId());
系统失败-->打印error日志等待下一次触发

## 标记死亡任务--DeadTask
```java
/**
 * <p>Description:
 * 标记消息死亡定时任务
 * </p>
 *
 * @author Chen Nan
 * @date 2019/3/28.
 */
```
1.获取最大重试次数n  
2.查询消息表中最大重试次数大于等于n且未标记已死亡的消息，标记为已死亡

## 重发任务
```java
/**
 * <p>Description:
 * 消息恢复子系统定时任务，
 * </p>
 *
 * @author Chen Nan
 * @date 2019/3/18.
 */
```
1.获取最大重试次数n  
2.按重发次数从高到低，分批次重发消息，从重发次数n开始  
3.查询条件（累计多长时间未确认、消息状态为发送中、消息未死亡、重发次数为n、排序字段为确认时间）  
4.查出消息多线程处理，发送消息更新发送次数